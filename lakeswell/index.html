<!doctype html> 
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mark's lakeswell page</title>
  <script src="https://code.jquery.com/jquery-1.9.1.js"></script>
  <script src="https://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
  <script src="jquery.ui.touch-punch.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.8.0/suncalc.min.js"></script>
  <script type="text/javascript" src="jquery.imgpreload.js"></script>
  <script type="text/javascript" src="temp_lookup.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
     integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
        crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
	     integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
	        crossorigin=""></script>

  <link rel="stylesheet" href="https://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css" />

  <link href="style.css" type="text/css" rel="stylesheet" />
  <link href='https://fonts.googleapis.com/css?family=Amatic+SC' rel='stylesheet' type='text/css'>

  <link rel="icon" href="favicon.ico" type="image/x-icon"> 
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon"> 



  <script>
  var map;
  var url_base="https://www.glerl.noaa.gov/res/glcfs/";
  var url_base2="https://www.glerl.noaa.gov/emf/";
  var max_hour= 71;
  var min_hour= -40;

  var lg=-79.7310;
  var lt=43.2795;

  var sc=SunCalc.getTimes(new Date(), lt, lg);

  console.log("at 55 wear "+(wear_at_temp(55))+"\n");
  console.log("sunrise at "+sc.sunrise.getHours() +":"+ sc.sunrise.getMinutes() );
  console.log("sunset at "+sc.sunset.getHours() +":"+ sc.sunset.getMinutes() );
  var fulllk;

  function format_url(prefix,offset,suffix) {
    return prefix + offset + suffix;
  }
  function new_format(lk,fulllk,basename,offset) {
    if(offset>=0) {
	    return format_url( url_base + fulllk + "/forecast/cur/" + lk + basename + "+" , offset , ".png");
    } else {
	    return format_url( url_base + fulllk + "/cur/" + lk + basename + "-" , 0-offset , ".png");
    }
  }
  function wind_and_currents(lk,fulllk,offset) {
    var basename="wndcur";
    return new_format(lk,fulllk,basename,offset-1);
  }
  function waves(lk,offset) {
    var offset = offset > 0 ? offset : offset-7;
    if(offset>0) {
	    return format_url( url_base2 + "/waves/WW3/images/" + "ww3gl" + lk + "-" , offset , ".png" );
    } else {
	    return format_url( url_base2 + "/waves/WW3/images/" + "ww3gl" + lk + "-" , 0-offset , ".png" );
    }
  }
  function wind(lk,offset) {
    var offset = offset > 0 ? offset : offset-7;
    if(offset>0) {
	    return format_url( url_base2 + "/waves/WW3/images/" + "ww3wngl" + lk + "-" , offset , ".png" );
    } else {
	    return format_url( url_base2 + "/waves/WW3/images/" + "ww3wngl" + lk + "-" , 0-offset , ".png" );
    }
  }
  function temperatures(lk,fulllk,offset) {
    var basename="swt";
	var lk2 = lk;
	var fulllk2 = fulllk;
	if(lk === "m" || lk == "h") {
		lk2 = "mh";
		fulllk2 = "mich-huron";
	}
    return new_format(lk2,fulllk2,basename,Math.floor((offset-1)/3));
  }
  function get_full_lake(lk) {
    var fulllk;
    if(lk == "o") {
	fulllk="ontario_hires";
    } else if(lk == "m") {
	fulllk="mich";
    } else if(lk == "h") {
	fulllk="huron";
    } else if(lk == "e") {
	fulllk="erie";
    } else { // "s"
	fulllk="superior_hires";
    }
    return fulllk;
  }
  function showLake(lk) {
    //preload images from -48 to 72
  fulllk=get_full_lake(lk);

  if(map) {
    const lakemap = [ 
	  { name: 'o', lng: 43.62655, lat: -77.986635, zoom: 8 }, 
	  { name: 'm', lng: 43.50048, lat: -87.24812, zoom: 6 },
	  { name: 'e', lng: 42.12228, lat: -81.364878, zoom: 7 },
	  { name: 's', lng: 47.781458, lat: -87.16837, zoom: 7 },
	  { name: 'h', lng: 45.02780, lat: -82.41437, zoom: 6 }
	  ];
    var lake;
    for(var k=0; k<lakemap.length; k++) {
	  if(lakemap[k].name === lk) {
		  lake = lakemap[k];
		  break;
	  }
    }
    map.setView([lake.lng,lake.lat],lake.zoom);
  }


  var the_images = [];
  var cast = "";
  for (var i = min_hour; i < max_hour+1; i++){
    var offset = i;
    //the_images.push(wind_and_currents(lk,fulllk,offset));
    the_images.push(wind(lk,offset));
    the_images.push(waves(lk,offset));
    the_images.push(temperatures(lk,fulllk,offset));
  }
  

  
      $( "#slider" ).slider({
	  background: 100, 
      range: "min",
      min: min_hour,
      max: max_hour,
      value: 01,

      slide: function( event, ui ) {
        var offset = ui.value;

        $("#amount").text( offset );
        $("#wind").attr("src",wind(lk,offset));
        $("#waves").attr("src",waves(lk,offset));
        $("#temps").attr("src",temperatures(lk,fulllk,offset));
        //$("#currents").attr("src",url_base +lk+"sfcur"+ offset +".gif"); 

	// debug stuff:
        /*
	$("#temps_title").text( $("#temps").attr("src").substring(36) );
	$("#currents_title").text( $("#currents").attr("src").substring(36) );
	$("#wind_title").text( $("#wind").attr("src").substring(36) );
	$("#waves_title").text( $("#waves").attr("src").substring(36) );
        */
      }
    });    

	$("#wind").attr("src",wind(lk,1));
	$("#waves").attr("src",waves(lk,1));
	$("#temps").attr("src",temperatures(lk,fulllk,1));
	//$("#currents").attr("src",url_base+lk+"sfcur+01.gif");        
	
	$("#graph_container").fadeIn(1000);

	$("#graph_container2").fadeIn(1000);
  
  
  	var loaded = 0;
	var total = (max_hour - min_hour+1) *4;
  
  		jQuery.imgpreload(the_images,
		{
			each: function()
			{
			  loaded++;
			var percentage = parseInt(loaded / total * 100) + '%';
			$('#progress-bar').html("Loading images: "+percentage);
			},
			all: function()
			{
    	  
				$('#progress-bar').fadeOut(300);

				//enable slider
				$( "#slider" ).slider("enable");
				
				//load images for +01 (fade in?)
	
			}
		});
		
  }

  function newLakeOnClick(elmt) {
	  console.log(elmt.href);
  }

  const glservice_prefix = 'https://flawless-kindhearted-veterinarian.glitch.me/';
  //const glservice_prefix = 'http://127.0.0.1:5000/'


  $(function() {
	  $("#elake").on('click', function () { showLake("e"); $("button.dropbtn").text("Lake Erie"); });
	  $("#mlake").on('click', function () { showLake("m"); $("button.dropbtn").text("Lake Michigan"); });
	  $("#hlake").on('click', function () { showLake("h"); $("button.dropbtn").text("Lake Huron"); });
	  $("#slake").on('click', function () { showLake("s"); $("button.dropbtn").text("Lake Superior"); });
	  $("#olake").on('click', function () { showLake("o"); $("button.dropbtn").text("Lake Ontario"); });

	  map = L.map('selectmap').setView([43.62655,-77.986635], 8);
	  L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
		      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
		      subdomains: [ 'a', 'b', 'c' ]
	  }).addTo(map);
	  showLake("o");

	  // place specific locations here
	  $.getJSON(glservice_prefix + 'conditionLocations.json', function (placemap) {
		placemap.forEach( function (place,ii) {
				L.marker(place.coord)
				.addTo(map)
				.on( 'click', function (e) {
					console.log(e.latlng);
					location.href = 'dygraphs.html?location=' + place.name
					;
				});
		});

	  });


	  // trigger draw of map
          setTimeout(() => {
	             map.invalidateSize();
	  }, 200);
  });
  </script>
  
  <style type="text/css">
  
  </style>

</head>
<body>
<div class="dropdown">
	<button class="dropbtn">Lake Ontario</button>
	<div class="dropdown-content">
		<a id="olake" onclick="newLakeOnClick(this)">Ontario</a>
		<a id="mlake" onclick="newLakeOnClick(this)">Michigan</a>
		<a id="hlake" onclick="newLakeOnClick(this)">Huron</a>
		<a id="elake" onclick="newLakeOnClick(this)">Erie</a>
		<a id="slake" onclick="newLakeOnClick(this)">Superior</a>
	</div>
</div>

<div id="top">
<div class="title" id="amount">+01</div>
<div class="title">hrs</div>
<div class="title" id="progress-bar"></div>
<div id="slider"></div>
</div> 

<p id="waves_title"> waves </p> 
<p id="wind_title"> winds </p>


<div style="clear:both;" ></div>
<div id="row">
   <div id="graph_container">
	<div class="container">
		<img id="waves" class="graphs" src="#" alt=""/> 
	</div>	
	<div class="container">
		<img id="temps"  class="graphs" src="#" alt="" /> 

	</div>	
	
   </div> 
   <!-- <div style="clear:both;" ></div>  -->
   <div id="graph_container2">
	<div class="container">
		<img id="wind"  class="graphs" src="#" alt="" /> 

	</div>	
	<div id="selectmap"></div>
   </div> 

<div style="clear:both;" ></div>
<p id="temps_title"> temperatures </p> 

<br/>
<p><a href="https://tidesandcurrents.noaa.gov/ofs/dev/ofs_animation.shtml?ofsregion=lo&subdomain=0&model_type=wind_forecast"> OFS Wind Forecast</a> </p>

<div id="footer">
<p >Images from <a href="http://www.glerl.noaa.gov/res/glcfs/" target="_blank">GLCFS by GLERL</a>.</p> 
<p> Weather data from <a href="
</div>


</body>
</html>


